
<!DOCTYPE html>
<html>
<head>

	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<link rel="stylesheet" href="style/bootstrap.min1.css" />
	<link rel="stylesheet" href="style/main-template.css" />
    <link type="text/css" href="style/style.css" rel="stylesheet" />
    <link type="text/css" href="style/checkboxstyle.css" rel="stylesheet" />
	
	<script src="js/jquery-1.11.2.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/bootstrap-dropdown.js"></script>	
	<script type="text/javascript" src="web.api.js"></script>
	<script type="text/javascript" src="web.control.js"></script>
	
	<title>Mainframe</title>
	<script>
		
		function IsJsonString(str) {
            try {
                JSON.parse(str);
            } catch (e) {
                return false;
            }
            return true;
        }


        function LoadRootObjects()
        {
            var guids = [ '00000001-0001-0001-0001-000000000001' ];
            api.getObjects(guids, function (result) {

                if (!IsJsonString(result)) {
					alert("Incorrect data format");
                    return;
                }

                var root = JSON.parse(result)[0];
				
				// —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ—Ä–Ω–µ–≤–æ–π "–∫—Ä–æ—à–∫–∏"
				var partOfRootBreadCrumbId = 'root';
				var rootBreadCrumbLabel = '–ö–æ—Ä–Ω–µ–≤–∞—è –ø–∞–ø–∫–∞';
							
				// –∏–∑–º–µ–Ω–µ–Ω–∏–µ url
				history.pushState(null, null, "?id=" + root.Id);
				
				createBreadCrumb('navigation', partOfRootBreadCrumbId, '#');
				addBreadCrumbContent(partOfRootBreadCrumbId, rootBreadCrumbLabel, root.Id);
				addBreadCrumbEventListener(partOfRootBreadCrumbId);
				
                var childrenIds = root.Children.Tree;
                api.getObjects(childrenIds, function (children) {

					api.getMetadata(function(result){
						
						if (!IsJsonString(result)) {
							alert("Incorrect data format!");
							return;
						}
				
						window.meta = JSON.parse(result);
					}, errorGetMetaData);
                    OnChildrenLoaded(JSON.parse(children));
                }, errorGetObjects)
                
            }, errorGetObjects
			)
        }

		
        function OnChildrenLoaded(children)
        {
			var count = 100500;
			var text;
			var chil;
			var typeId;
            var val;
			var size;
			var hasFiles;
			var idFiles;
            for (var i in children) {
				val = children[i];
				typeId = children[i].TypeId;
				count = (children[i].Children.Tree).length;
				text = GetTitle(val.Attributes);	
				var root = window.meta;
				for (var j in root.Types) {
					if (root.Types[j].Id == typeId) {
						icon = root.Types[j].Icon;
						hasFiles = root.Types[j].HasFiles;
						if(hasFiles){
							idFiles = children[i].Files[0].Body.Id;
							size = children[i].Files[0].Body.Size;
						//	alert(children[i].Files[0].Name);
						}
					}
					
				}
				createItem('content', i, 'data:image/svg+xml;base64,' + icon );
				addFolderEventListener(i);
				addInnerFolderContent(i, count, text, children[i].Id , hasFiles, idFiles, size);
            }
        }

        function GetTitle(attributes)
        {
            var result = '';
			var name = '';
			var customer = '';
			var project_name = '';
			var code = '';
			
			for (var i in attributes) {
				if (i == 'name') {
					if(name != null)
						name = attributes[i].StrValue;
				}
				if (i == 'project_name') {
					if(project_name != null)
						project_name = attributes[i].StrValue;
				}
				if (i == 'code') {
					if(code != null)
						code = attributes[i].StrValue;
				}
			}
			result = code + " " + name + " " + project_name ;
            return result;
        }

		// ‚ÓÁ‚‡˘‡ÂÚ cookie Ò ËÏÂÌÂÏ name, ÂÒÎË ÂÒÚ¸, ÂÒÎË ÌÂÚ, ÚÓ undefined
		function getCookie(name) {
		  var results = document.cookie.match ( '(^|;) ?' + name + '=([^;]*)(;|$)' );
		 
		  if ( results )
		    return ( unescape ( results[2] ) );
		  else
		    return null;
		}
		
		function mouseenterVisible(event){
		
			var myId = {};
			if(!tryGetId(event, myId)){
				alert('I can\'t get element\'s id');
				return;
			}
			var div = document.getElementById(myId.id);
			var elems = div.getElementsByTagName('input');
			for(var i=0; i<elems.length; i++) 
				document.getElementById(elems[i].id).style.visibility = "visible";
			return true;
		}
		
		function mouseleaveVisible(event){
		
			var myId ={};
			if(!tryGetId(event, myId)){
				alert('I can\'t get element\'s id');
				return;
			}
			var div = document.getElementById(myId.id);
			var elems = div.getElementsByTagName('input');
			
			for(var i=0; i<elems.length; i++) {
				if(document.getElementById(elems[i].id).checked)
					document.getElementById(elems[i].id).style.visibility = "visible";	
				else
					document.getElementById(elems[i].id).style.visibility = "hidden";			
			}
		}

		function mouseClickFolderLink(){
		
			// –ø–æ–ª—É—á–µ–Ω–∏–µ id —ç–ª–µ–º–µ–Ω—Ç–∞, —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–≤—à–µ–≥–æ —Å–æ–±—ã—Ç–∏–µ
			var myId ={};
			if(!tryGetId(event, myId)){
				alert('I can\'t get element\'s id');
				return;
			}
			
			// –ø–æ–ª—É—á–µ–Ω–∏–µ —á–∞—Å—Ç–∏ id, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–π –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è id folder, —Å–æ–¥–µ—Ä–∂–∞—â–µ–π ids
			var id = {};
			if(!tryFindPartId(myId.id, id)){
				alert('I can\'t find id');
				return;
			}			
			
			var testChildren = document.getElementById('childrenCount-' + id.partId).innerHTML;
			var testHasFiles = document.getElementById('folder-' + id.partId).dataset.hasFiles;

			if(testChildren != 0 & !testHasFiles){

			// –ø–æ–ª—É—á–µ–Ω–∏–µ ids	
				var ids = document.getElementById('folder-' + id.partId).dataset.ids;
				
			// –∏–∑–º–µ–Ω–µ–Ω–∏–µ url
				history.pushState(null, null, "?id=" + ids);
			
			//	–ø–æ–ª—É—á–µ–Ω–∏–µ road			
				var div = document.getElementById('navigation');
				var elems = div.getElementsByTagName('LI');
				var liLength = elems.length - 1;
				var elemslinks = elems[liLength].getElementsByTagName('A');
				var aLength = elemslinks.length - 1;
				var road = elemslinks[aLength].dataset.road;

			// —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è "–∫—Ä–æ—à–∫–∏"
				var breadCrumbLabel = document.getElementById('folderLinkTextp-' + id.partId).innerHTML;
			// —Å–º–µ–Ω–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞	
				document.title = breadCrumbLabel;
				
				if(!createBreadCrumb('navigation', road + '' + id.partId, '#')){
					alert('I can\'t create breadcrumb ');
					return;
				}else{
					if(!addBreadCrumbContent(road + '' + id.partId, breadCrumbLabel, ids)){
						alert('I can\'t add breadcrumb ');
						return;
					}else{
						addBreadCrumbEventListener(road + '' + id.partId);
						LoadFolderContent(ids);		
					}
				}
			} else{
				// –ø–æ–ª—É—á–µ–Ω–∏–µ idFiles	
				var idFiles = document.getElementById('folder-' + id.partId).dataset.idFiles;
				
				// –ø–æ–ª—É—á–µ–Ω–∏–µ sizeFiles	
				var sizeFiles = document.getElementById('folder-' + id.partId).dataset.sizeFiles;
				
				api.openFile(idFiles, sizeFiles, function(result){
				alert(result);
				
				}, errorGetFile);
			
			}
		
		}
		
		function errorGetObjects() {
			alert("Can\'t get objects");
		}
		
		function errorGetMetaData() {
			alert("Cant\'t get metadata");
		}
		
		function errorGetFile() {
			alert("Cant\'t get file");
		}
		
		function LoadFolderContent(ids){
					
		// –æ—á–∏—Å—Ç–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ content
			document.getElementById("content").innerText = '';
				
			ids = [ ids ];
            api.getObjects(ids, function (result) {

			alert(result);
				if (!IsJsonString(result)) {
					alert("Incorrect data format");
					return;
				}

				var newFolder = JSON.parse(result)[0];
				var childrenIds = newFolder.Children.Tree;
				api.getObjects(childrenIds, function (children) {
					OnChildrenLoaded(JSON.parse(children));
				},errorGetObjects)
  
            }, errorGetObjects);
		
		}
		
		
		function tryFindPartId(str, result){
		
			try{
				var start = str.indexOf('-');
				result.partId = str.substring(start + 1, str.length);
				return true;
			} catch(e){
				return false;
			}
		
		}
		
		function mouseClickBreadCrumb(event){
			
			var myId = {};
			if(!tryGetId(event, myId)){
				alert('I can\'t get element\'s id');
				return;
			}

			// —Å–º–µ–Ω–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞	
				document.title = document.getElementById(myId.id).innerText;
			
			//	–ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Å–ø–∏—Å–∫–∞			
			var div = document.getElementById('navigation');

			var length = document.getElementById('navigation').getElementsByTagName('li').length;			
			var road = document.getElementById(myId.id).dataset.road;
			var count = (road.split('*').length - 1);

			for(var i=count-1; i<length-1; i++){
			
				var idRemovingElement = document.getElementById('navigation').lastElementChild.id;
				var removingElement = document.getElementById(idRemovingElement);
				div.removeChild(removingElement);
			}
			
			// –ø–æ–ª—É—á–µ–Ω–∏–µ ids	
			var ids = document.getElementById(myId.id).dataset.ids;			
			
			LoadFolderContent(ids);	

		}
		
		function tryGetId(event, myId){
			try{
				event = event || window.event;
				// –¢–µ–ø–µ—Ä—å event - –æ–±—ä–µ–∫—Ç —Å–æ–±—ã—Ç–∏—è –≤–æ –≤—Å–µ—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö.
				var sender = event.srcElement || event.target;
				myId.id = sender.id;
				return true;
			}catch(e){
				return false; 
			}
		}
		
		function createElement( name, attributes ) {
		    var el = document.createElement( name );
		    if ( typeof attributes == 'object' ) {
				for ( var i in attributes ) {
					el.setAttribute( i, attributes[i] );

					if ( i.toLowerCase() == 'class' ) {
						el.className = attributes[i];  
					} else if ( i.toLowerCase() == 'src' ) {
						el.src = attributes[i]; 
					} else if ( i.toLowerCase() == 'href' ) {
						el.href = attributes[i]; 
					} else if ( i.toLowerCase() == 'alt' ) {
						el.alt = attributes[i]; 
					} else if ( i.toLowerCase() == 'type' ) {
						el.type = attributes[i]; 
					}
				}
			}
			for ( var i = 2; i<arguments.length; i++ ) {
				var val = arguments[i];
				if ( typeof val == 'string' ) { val = document.createTextNode( val ) };
				el.appendChild( val );
			}
			return el;
		}
		
		function createBreadCrumb(parentId, i, ihref){
		
			var holder = document.getElementById( parentId );
			if( holder != null ){
			var list;
				try{
					holder.appendChild( 
						list = 
							createElement( "li", {id: 'breadcrumb-'+i}, 
								createElement( "a", {id: 'link-'+i, class: 'link', href: ihref} )
							)
					);
				}catch(e){
					alert('I can\'t create and add element');
				}
				return true;
			}else
				return false;
			
		}
		
		function addBreadCrumbContent(i, content, ids){
	
			try{
				document.getElementById('link-' + i).innerHTML = content;
				document.getElementById('link-' + i).dataset.ids = ids;
				document.getElementById('link-' + i).dataset.road =  i + '*';	//*	
				return true;
			}catch(e){
				return false;
			}	
		
		}
		
		function addBreadCrumbEventListener(i){
		
			try{
				document.getElementById('link-' + i).addEventListener("click", mouseClickBreadCrumb);
				return true;
			}catch(e){
				return false;
			}
		}
		
		
		function createItem(parentId, i, isrc){
		
			var holder = document.getElementById( parentId );
			if( holder != null ){
				var folder;
				var img, div, input, label;
				try{
					holder.appendChild( 
						folder = 
							createElement( "div", {id: 'folder-'+i, class: 'folder'}, 
								createElement( "a", {id: 'folderLink-'+i, class: 'folderLink' },
									createElement( "div", {id: 'folderLinkImg-'+i, class: 'folderLinkImg'}, 
										createElement( "div", { id: 'childrenCount-'+i, class: 'childrenCount' }
										),
										img = 
										createElement( "img", {id: 'folderLinkImgIcon-', src: isrc, alt: ''}
										)				
									),
									div = 
									createElement( "div", {id: 'folderLinkText-'+i, class: 'folderLinkText'},
										createElement( "p", {id: 'folderLinkTextp-'+i}
										)
									)
								),		
								input = 
								createElement( "input", {id: 'input-'+i, type: 'checkbox' } //, class: 'css-checkbox lrg'} 
//								),
//								label = 
//								createElement( "label", {id: 'label-'+i, for: 'input-'+i, class: 'css-label lrg web-two-style'} 
															
								)			
							)
					);
				}catch(e){
					alert('Can\'t create and element');
				}
			}else
				return false;
		}
		
		function addFolderEventListener(i){
		
			try{
				document.getElementById('folder-' + i).addEventListener("mouseenter", mouseenterVisible);
				document.getElementById('folder-' + i).addEventListener("mouseleave", mouseleaveVisible);
				document.getElementById('folderLink-' + i).addEventListener("click", mouseClickFolderLink);
				
				return true;
			}catch(e){
				return false;
			}
		}
		
		function addInnerFolderContent( i, childrenCount, folderLinkTextp, ids, hasFiles, idFiles, sizeFiles){
			
			try{
				document.getElementById('childrenCount-' + i).innerHTML = childrenCount;
				document.getElementById('folderLinkTextp-' + i).innerHTML = folderLinkTextp;
				document.getElementById('folder-' + i).dataset.ids = ''+ids+'';
				document.getElementById('folder-' + i).dataset.hasFiles = hasFiles;
				if(hasFiles){				
					document.getElementById('folder-' + i).dataset.idFiles = idFiles;
					document.getElementById('folder-' + i).dataset.sizeFiles = sizeFiles;
				}
				return true;
			}catch(e){
				return false;
			}		
		}
				
	</script>

</head>
<body>

	<div class="navbar navbar-default" id="mainbrand">
		<div class="navbar-inner">
			<p class="navbar-text pull-left" id="inbrand1">
				Base name: <a  class="navbar-link" id="basename"></a>
			</p>
			<p class="navbar-text pull-left" id="inbrand1">
				Base version: <a  class="navbar-link" id="baseversion"></a>
			</p>
			<p class="navbar-text pull-right" id="inbrand2">
				Logged in as <a  class="navbar-link" id="username"></a>
			</p>

		</div>
	</div>	
		<ol class="breadcrumb" id="navigation">

		</ol>

		<div class="main" id="main">

			<div class="content foldersContent" id="content">
				
			</div>

			<div class="clearfix"></div>
			<div class="content documentsContent"></div>
			<div class="clearfix"></div>
		</div>
	<div class="clear"></div>
<script type="text/javascript">
	
	document.getElementById('basename').innerHTML = getCookie('baseName');
	document.getElementById('baseversion').innerHTML = getCookie('databaseVersion');
	document.getElementById('username').innerHTML = getCookie('userName');
	api.currentHost = getCookie('nginxHost');
	
	// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è "popstate": 
	window.addEventListener('popstate', function(event) { 
	
		//	–ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Å–ø–∏—Å–∫–∞			
		var div = document.getElementById('navigation');
		var length = document.getElementById('navigation').getElementsByTagName('li').length;
		
		if(length>1){
			var idRemovingElement = document.getElementById('navigation').lastElementChild.id;
			var removingElement = document.getElementById(idRemovingElement);
			div.removeChild(removingElement);
			var idNewLastElement = document.getElementById('navigation').lastElementChild.id;
			var partOflinkIntoBreadCrumbid = {};
			
			if(!tryFindPartId(idNewLastElement, partOflinkIntoBreadCrumbid)){
				alert('Can\'t find id');
				return;
			}				
			// –ø–æ–ª—É—á–µ–Ω–∏–µ ids	
			var ids = document.getElementById('link-' + partOflinkIntoBreadCrumbid.partId).dataset.ids;	
			// —Å–º–µ–Ω–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞	
			document.title = document.getElementById('link-' + partOflinkIntoBreadCrumbid.partId).innerText;
			
			LoadFolderContent(ids);
		}else{
			var ids = document.getElementById('link-root').dataset.ids;	
			// –∏–∑–º–µ–Ω–µ–Ω–∏–µ url
			history.pushState(null, null, "?id=" + ids);
		}
  
	},  false); 
	
	LoadRootObjects();
	

	
</script>

</body>
</html>
